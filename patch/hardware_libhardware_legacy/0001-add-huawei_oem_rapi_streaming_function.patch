From 5804ddb54d59c9276decc899ed51023a64077166 Mon Sep 17 00:00:00 2001
From: Daz Jones <yuki@thebronasium.com>
Date: Fri, 10 Aug 2012 17:02:03 -0700
Subject: [PATCH] Add huawei_oem_rapi_streaming_function

Change-Id: Ib7ec3632f823258fb7390bf928759f1c1b7f8860
---
 Android.mk  |    2 +-
 wifi/wifi.c |   19 ++++++++++++++++++-
 2 files changed, 19 insertions(+), 2 deletions(-)

diff --git a/Android.mk b/Android.mk
index 1faf6e2..e61e77d 100644
--- a/Android.mk
+++ b/Android.mk
@@ -9,7 +9,7 @@ LEGACY_AUDIO_MAKEFILES := $(call all-named-subdir-makefiles,audio)
 LOCAL_PATH:= $(call my-dir)
 include $(CLEAR_VARS)
 
-LOCAL_SHARED_LIBRARIES := libcutils libwpa_client
+LOCAL_SHARED_LIBRARIES := libcutils libwpa_client libhwrpc
 
 LOCAL_INCLUDES += $(LOCAL_PATH)
 
diff --git a/wifi/wifi.c b/wifi/wifi.c
index 3660657..b440485 100644
--- a/wifi/wifi.c
+++ b/wifi/wifi.c
@@ -61,6 +61,8 @@ extern void get_dhcp_info();
 extern int init_module(void *, unsigned long, const char *);
 extern int delete_module(const char *, unsigned int);
 
+extern void huawei_oem_rapi_streaming_function(int n, int p1, int p2, int p3, char *v1, int *v2, int *v3);
+
 static char primary_iface[PROPERTY_VALUE_MAX];
 // TODO: use new ANDROID_SOCKET mechanism, once support for multiple
 // sockets is in
@@ -171,12 +173,27 @@ static int insmod(const char *filename, const char *args)
     void *module;
     unsigned int size;
     int ret;
+    char x[8];
+    int  y;
+    char mac_param[128];
+    char cust_mac_param[128];
 
     module = load_file(filename, &size);
     if (!module)
         return -1;
 
-    ret = init_module(module, size, args);
+    property_get("persist.sys.wifimac", cust_mac_param, "");
+    if (!strcmp(cust_mac_param, "")) {
+        memset(x, 0, 8);
+        y = 0;
+        huawei_oem_rapi_streaming_function(3, 0, 0, 0, 0, &y, x);
+        ALOGI("huawei_oem_rapi_streaming_function %p %x %x", x, x[0], y);
+        sprintf(mac_param, "mac_param=%02X:%02X:%02X:%02X:%02X:%02X %s", x[5], x[4], x[3], x[2], x[1], x[0], args);
+    } else {
+        sprintf(mac_param, "mac_param=%s %s", cust_mac_param, args);
+    }
+    ALOGI("Got MAC Address: %s ", mac_param);
+    ret = init_module(module, size, mac_param);
 
     free(module);
 
-- 
1.7.0.4
